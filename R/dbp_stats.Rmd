---
title: "DBP stats for `r params$name`"
output:
  pdf_document: default
  html_document: default
params:
  name: dbp_sim_data_20190226
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(tidyverse)
library(scales)
library(lemon)
library(knitr)
library(lubridate)
library(REdaS)
theme_set(theme_light())
source("R/dbp_stat_functions.R")
knitr::opts_chunk$set(fig.width=6, fig.height=4) 
```

```{r lens, include = FALSE}
lens <- read_delim(str_c("data/",params$name, ".csv"), delim = ";",
                   col_types = cols(
                                  .default = col_double(),
                                  JOB = col_character(),
                                  EYE = col_character(),
                                  TIMESTAMP = col_character(),
                                  LMRDONE = col_logical(),
                                  LMTDONE = col_logical(),
                                  POLAR = col_logical(),
                                  TINT = col_character(),
                                  LTYPE = col_character(),
                                  LDVEN = col_character(),
                                  LNAME = col_character(),
                                  ENGLOC = col_character(),
                                  POS34VALID = col_logical(),
                                  POSPEVALID = col_logical(),
                                  DBPVALID = col_logical(),
                                  LMERRMSG = col_character()
                                  )
) %>% 
    mutate(
        #POS34VALID = parse_logical(POS34VALID),
        #POSPEVALID = parse_logical(POSPEVALID),
        #POLAR = parse_logical(POLAR),
        #DBPVALID = parse_logical(DBPVALID),
        TOLVPRVH = get_tolvprvh(LDDRSPH, LDDRCYL),
        TOLVPRVV = get_tolvprvv(LDDRSPH, LDDRCYL),
        TIMESTAMP = ymd_hms(TIMESTAMP),
        POSPEID = factor(POSPEID),
        POSPEID = fct_recode(POSPEID, 
                             AutoPosPE = "0", 
                             SquareNotFound = "20060", 
                             EyeNotFound  = "20217",
                             BadEye = "20210",
                             InvalidMode = "20202"
                             ),
        LMERRCODE = as.factor(LMERRCODE),
        #LMTDONE = parse_logical(LMTDONE),
        #LMRDONE = parse_logical(LMRDONE),
        LMERRCODE = fct_recode(LMERRCODE, 
                                NoError = "0",
                                NoError = "21273",
                                NoError = "21315",
                                PatternError = "21013",
                                PatternError = "21223",
                                ProtectedMemoryError = "20899"
                                )
        )
```

## 1. Data processing and lens statistics

```{r lens_pr}
lens_pr <- lens %>% 
    filter(
        !(LMTDONE == FALSE & LMRDONE == FALSE & LMERRCODE == "NoError"),
        str_detect(LTYPE, "PR FF")
        )
```

The applied filter selects the rows that are compliant with the following conditions :

* LTYPE includes PR FF
* !(DLM.ReflectionResults.Done == FALSE && DLM.TResults == FALSE && DLM.LMERRCODE ==  0)

The total number of lenses included is : `r lens_pr %>% nrow`.

Some basic statistics :

```{r lens statistics}
lens_pr %>% 
    mutate(
        LDDRSEQ = LDDRSPH + LDDRCYL/2,
        LDDRCYL = abs(LDDRCYL)
        ) %>% 
    select(LDDRSEQ, LDDRCYL, LDADD) %>% 
    gather(NAME, VALUE) %>% 
    mutate(NAME = factor(NAME, levels = c("LDDRSEQ", "LDDRCYL", "LDADD"))) %>% 
    ggplot(aes(VALUE)) +
    geom_histogram(bins = 20, aes(fill = NAME), color = "black", alpha = 1) +
    facet_wrap(~ NAME, scales = "free")+
    guides(fill = FALSE)+
    labs(
        x = "[D]",
        y = "",
        title = ""
    )
    
```


## 2. Preliminary engravings detection and position 

### 2.1 PE Automatic detection rate

```{r}
geom_bar_cnt(lens_pr, "POSPEID")
```


More details about errors per LDVEN : 

```{r}
lens_pr %>% 
    #filter(POSPEID == "SquareNotFound") %>% 
    ggplot(aes(POSPEID, fill = LDVEN)) +
    geom_bar()
```

More details about the SquareNotFound error for Essilor designs:

```{r}
lens_pr %>% 
    filter(POSPEID == "SquareNotFound", LDVEN == "ESSILOR") %>% 
    count(LNAME) %>% 
    arrange(desc(n)) %>% 
    mutate(LNAME = fct_reorder(as.factor(LNAME), n)) %>% 
    ggplot(aes(x = LNAME, y = n, fill = LNAME)) + 
    geom_bar(stat = "identity") +
    coord_flip() +
    guides(fill = FALSE) +
    labs(
        title = "Essilor LNAME leading to SquareNotFoundError",
        y = "Number of misses",
        x = "LNAME"
    )
```

```{r}
lens_pr %>% 
    mutate(SPH = round(LDDRSPH) %>% as.factor()) %>% 
    filter(POSPEID %in% c("AutoPosPE", "SquareNotFound")) %>% 
    mutate(SNF = (POSPEID == "SquareNotFound")) %>% 
    group_by(SPH) %>% 
    summarize(SNF_per = mean(SNF)) %>% 
    ggplot(aes(x = SPH, y = SNF_per, fill = SPH)) +
    geom_col()+
    scale_y_continuous(labels = percent)+
    labs(
        title = "Percentage of SquareNotFound errors vs. power",
        x = "SPH[D]",
        y = "%"
    )
```

More details about the Eye NotFound Error

```{r}
lens_pr %>% 
    filter(POSPEID == "EyeNotFound") %>% 
    count(LNAME, LDVEN) %>% 
    ggplot(aes(fct_reorder(LNAME, n), n, fill = LDVEN))+ 
    geom_col()+
    coord_flip()+
    labs(
        title = "LNAME creating EyeNotFound errors for the PE engravings",
        x = "LNAME",
        y = ""
    )
```




### 2.2 Preliminary engraving position vs. expected


Here the comparison of the position of the PRP based on the engravings at 34mm
and the PRP based on the preliminary engravings.


```{r lens_auto}
lens_pe_auto <- lens_pr %>% 
   filter(POSPEID == "AutoPosPE")
```


```{r PrpDelta_plot}
lens_pe_auto %>% 
    mutate(
       fcocx = FCOCIN * ((EYE=="R")-(EYE=="L")),
       fcocy = FCOCUP,
       PrpDeltaX = POSPEX + TPERRPEX + fcocx - (POS34X + TPERR34X),
       PrpDeltaY = POSPEY + TPERRPEY + fcocy - (POS34Y + TPERR34Y),
       PrpDeltaT = ((POSPET + TPERRPET)-(POS34T+TPERR34T)) %%180.0-90
       ) %>%
    select(PrpDeltaX, PrpDeltaY, PrpDeltaT) %>% 
    gather(Name, Value) %>% 
    mutate(Name = factor(Name, levels = c("PrpDeltaX", "PrpDeltaY", "PrpDeltaT"))) %>% 
    ggplot(aes(Value))+
    geom_histogram(bins = 40, color = "black", aes(fill = Name), alpha = 1) +
    scale_x_symmetric(lim = c(-1.,1.))+
    guides(fill = FALSE)+
    facet_wrap(~ Name) +
    labs(
        x = "",
        y = "",
        title = "Discrepencies between PE and 34mm engravings"
    )
```

#### Distribution averages

```{r}
lens_pe_auto %>% 
    mutate(
       fcocx = FCOCIN * ((EYE=="R")-(EYE=="L")),
       fcocy = FCOCUP,
       PrpDeltaX = POSPEX + TPERRPEX + fcocx - (POS34X + TPERR34X),
       PrpDeltaY = POSPEY + TPERRPEY + fcocy - (POS34Y + TPERR34Y),
       PrpDeltaT = ((POSPET + TPERRPET)-(POS34T+TPERR34T)) %%180.0-90
       ) %>%
    select(PrpDeltaX, PrpDeltaY, PrpDeltaT) %>% 
    summarize_all(mean) %>% 
    kable(digits = 2)
```


## 3. DLM and DBP success rate and output

### 3.1 DLM Error statistics


Here is the distribution of the DLM errors for the filtered lenses.
Note that a GNG error or GNG not tested is considered as no error here.

```{r}
geom_bar_cnt(lens_pr, "LMERRCODE")
```

#### More info for the PatternError

```{r}
lens_pr %>% 
    mutate(
        HASPNE = (LMERRCODE == "PatternError"),
        LIND = round(LIND, digits = 2),
        LIND = as.factor(LIND)
        ) %>% 
    group_by(LIND) %>% 
    summarize(
        HASPNE_pct = mean(HASPNE)
    ) %>% 
    ggplot(aes(LIND, HASPNE_pct, fill = LIND)) +
    geom_col()+
    scale_y_continuous(labels = percent)+
    guides(fill = FALSE) +
    labs(
        title = "Percentages of PatternError per LIND",
        x = "LIND",
        y = ""
    )
```

Here's the percentage of pattern error for each power
(at least 50 lenses per power to be considered here)

```{r}
lens_pr %>% 
    mutate(
        HASPNE = (LMERRCODE == "PatternError"),
        SPH = round(LDDRSPH),
        SPH = as.factor(SPH),
        LIND = round(LIND, digits = 2),
        LIND = as.factor(LIND)
        ) %>%  
    group_by(SPH) %>% 
    summarize(
        HASPNE_pct = mean(HASPNE),
        n = n()
    ) %>% 
    filter(n > 50) %>% 
    ggplot(aes(SPH, HASPNE_pct, fill = SPH)) +
    geom_col()+
    scale_y_continuous(labels = percent)+
    labs(
        title = "Percentages of PatternError per SPH",
        x = "SPH",
        y = ""
    )+
    guides(fill = FALSE)
```


```{r lens_pr_noerr}
lens_pr_noerr <- lens_pr %>% 
    filter(LMERRCODE == "NoError")
```



### 3.2 DBP success rate
Among the lenses without an error at the DLM , here is the percentage of successful DBP processing.

```{r DBP_success_rate_plot}
lens_pr_noerr %>% 
    mutate(
        DBPVALID = fct_recode(as.factor(DBPVALID), DBP_VALID = "TRUE", DBP_NOT_VALID = "FALSE")
        ) %>% 
    geom_bar_cnt("DBPVALID")
```

```{r}
lens_pr_noerr_dbpvalid <- lens_pr_noerr %>% 
    filter(DBPVALID == TRUE)
```


See the appendix for a list of the jobs with unsucessful DBP.

### 3.3 DBP values

Percentage of DBP values in interval [-2,2] for x and y and [-5,5] for $\theta$.

```{r}
lens_pr_noerr_dbpvalid %>% 
    filter(DBPVALID == TRUE) %>% 
    mutate(
        DBPINLIMIT = abs(DBPX) <= 2 && abs(DBPY) <= 2 && abs(DBPT) <= 5,
        DBPINLIMIT = fct_recode(as.factor(DBPINLIMIT), DBP_VAL_IN_LIM = "TRUE", DBP_VAL_OUT_LIM = "FALSE") 
    ) %>% 
    geom_bar_cnt("DBPINLIMIT")
```


```{r DBP X, Y and T plots}
lens_pr_noerr_dbpvalid %>% 
    select(DBPX, DBPY, DBPT) %>% 
    gather(NAME, VALUE) %>% 
    mutate(NAME = factor(NAME, levels = c("DBPX", "DBPY", "DBPT"))) %>% 
    ggplot(aes(VALUE)) +
    geom_histogram(bins = 50, aes(fill = NAME), color = "black", alpha = 1) +
    scale_x_symmetric(lim = c(-3,3))+
    facet_wrap(~ NAME)+
    guides(fill = FALSE)+
    labs(
        x = "",
        y = "",
        title = "DBP values"
    )
```

#### More info on the DBP X distribution in two groups

Two groups :

```{r}
lens_pr_noerr_dbpvalid %>% 
    ggplot(aes(DBPX)) +
    geom_histogram(fill = "#F8766D", color = "black", bins = 100) +
    scale_x_continuous(lim = c(-3,3), breaks = seq(-3,3, by = 0.5)) +
    geom_vline(xintercept = 0.5)
```


Influence of LNAME

```{r}
lens_pr_noerr_dbpvalid %>% 
    mutate(SHIFT = DBPX > 0.5) %>% 
    group_by(LNAME) %>% 
    summarize(
        per = mean(SHIFT),
        n = n()
        ) %>% 
    filter(n > 50) %>% 
    arrange(desc(per)) %>% 
    ggplot(aes(LNAME, per)) +
    geom_col(fill = "#F8766D", color = "black") +
    coord_flip() +
    scale_y_continuous(labels = percent) +
    guides(fill = FALSE) +
    labs(
        title = "Percentage of group 1 or 2 does not depend on LNAME",
        y = "",
        x = "LNAME"
         )
```

Influence of SBOCIN

```{r}
lens_pr_noerr_dbpvalid %>%
    filter(abs(DBPX) < 3) %>% 
    ggplot(aes(SBOCIN, DBPX)) +
    geom_point(alpha = .2, size = 2, color = "blue") +
    labs(
        title = "DBPX does not depend on SBOCIN"
    )
```

No influence of the eye

```{r}
lens_pr_noerr_dbpvalid %>%
    filter(abs(DBPX) < 3) %>%
    ggplot(aes(DBPX, fill = EYE)) +
    geom_histogram(bins = 100) +
    labs("")
```


No influence of the parallax computation

```{r}
lens_pr_noerr_dbpvalid %>%
    filter(abs(DBPX) < 3) %>%
    ggplot(aes(TPERR34X, DBPX))+
    geom_point(color = "blue", alpha = .2, size = 3)
```



#### Link between DBPX and the error on the prismatic value

Here we look at the horizontal prismatic error in term of shift in mm
using the power. The lenses have been divided into two groups, depending on
whether the DBPX is greater than 0.5 or not.


```{r}
lens_pr_noerr_dbpvalid %>%
    mutate(HIGHDBPX = DBPX > 0.5) %>% 
    filter(abs(DBPX) < 3) %>%
    mutate(
        INSPRVH_DBP = extrapolate_prvh(INSPRVH, INSPRVV, INSPRSPH, INSPRCYL, INSPRAX,
                                        -DBPX, -DBPY, -DBPT),
        INSPRVV_DBP = extrapolate_prvv(INSPRVH, INSPRVV, INSPRSPH, INSPRCYL, INSPRAX,
                                        -DBPX, -DBPY, -DBPT),
        REL_DPRVH = (INSPRVH-LDPRVH)/TOLVPRVH,
        REL_DPRVV = (INSPRVV-LDPRVV)/TOLVPRVV,
        REL_DPRVH_DBP = (INSPRVH_DBP - LDPRVH)/TOLVPRVH,
        REL_DPRVV_DBP = (INSPRVV_DBP - LDPRVV)/TOLVPRVV,
        DEC = -(INSPRVH - LDPRVH)/LDDRSPH*10,
        DEC_DBP = -(INSPRVH_DBP - LDPRVH)/LDDRSPH*10
        ) %>% 
    ggplot(aes(DEC)) +
    geom_histogram(aes(fill = HIGHDBPX), bins = 50)+
    geom_vline(xintercept = 0, alpha = .5)+
    geom_vline(xintercept = 1, alpha = .5)+
    facet_wrap(~HIGHDBPX)+
    scale_x_continuous(breaks = seq(-4, 4, by = 1), limits = c(-4,4))
```

We see the same distributions are found on the horizontal displacement calculated based on the prism
measured at the Focovision. This indicates that the shift of 1mm is also measured at the Focovision for half of the lenses.


### 3.4 DBP FE and SE values

These are the two validity criteria for the DBP.
DBPFE represents the average error and DBPSE the sensitivity
against shifting.

```{r DBP FE and SE plots}
lens_pr_noerr_dbpvalid %>% 
    select(DBPFE, DBPSE) %>% 
    gather(NAME, VALUE) %>% 
    ggplot(aes(VALUE)) +
    geom_histogram(bins = 30, aes(fill = NAME), color = "black", alpha = 1)+
    facet_wrap(~ NAME) +
    guides(fill = FALSE) +
    labs(
        x = "",
        y = ""
    )
```

## 4. Errors statistics with DBP OFF and ON

### 4.1 Relative prism error with DBP OFF and ON

Here are the relative error on the prismatic powers. 
This errors are the difference between the measured values and the verifications value divided by the tolerance
compliant with the ISO8980-2. The values with and without DBP are compared.

```{r rel prism errors}
lens_pr_noerr_dbpvalid %>% 
    mutate(
        INSPRVH_DBP = extrapolate_prvh(INSPRVH, INSPRVV, INSPRSPH, INSPRCYL, INSPRAX,
                                        -DBPX, -DBPY, -DBPT),
        INSPRVV_DBP = extrapolate_prvv(INSPRVH, INSPRVV, INSPRSPH, INSPRCYL, INSPRAX,
                                        -DBPX, -DBPY, -DBPT),
        REL_DPRVH = (INSPRVH-LDPRVH)/TOLVPRVH,
        REL_DPRVV = (INSPRVV-LDPRVV)/TOLVPRVV,
        REL_DPRVH_DBP = (INSPRVH_DBP - LDPRVH)/TOLVPRVH,
        REL_DPRVV_DBP = (INSPRVV_DBP - LDPRVV)/TOLVPRVV
        ) %>% 
    select(REL_DPRVH:REL_DPRVV_DBP) %>% 
    gather(NAME, VALUE) %>% 
    mutate(
        DBP = str_detect(NAME, "DBP"),
        DBP = fct_recode(as.factor(DBP), DPB_OFF = "FALSE", DBP_ON = "TRUE"),
        NAME = str_replace(NAME, "_DBP", "")
        ) %>% 
    ggplot(aes(VALUE)) + 
    geom_histogram(bins = 50, aes(fill = NAME), color = "black", alpha = 1)+
    facet_grid(DBP ~ NAME) +
    guides(fill = FALSE) +
    scale_x_symmetric(lim = c(-1,1), labels = percent)+
    labs(
        x = "Relative prismatic error [%]",
        y = ""
    )
```

### 4.2 Vector cylinder power errors with DBP OFF and ON

```{r cylv errors}
lens_pr_noerr_dbpvalid %>% 
    mutate(
        DAX = -DBPT,
        INSDRAX_DBP = INSDRAX-DAX,
        DCYLV = cylv_diff(INSDRCYL, INSDRAX, LDDRCYL, LDDRAX),
        DCYLV_DBP = cylv_diff(INSDRCYL, INSDRAX_DBP, LDDRCYL, LDDRAX)
    ) %>% 
    select(DCYLV, DCYLV_DBP) %>% 
    gather(NAME, VALUE) %>% 
    mutate(
        DBP = str_detect(NAME, "DBP"),
        DBP = fct_recode(as.factor(DBP), DPB_OFF = "FALSE", DBP_ON = "TRUE"),
        NAME = str_replace(NAME, "_DBP", "")
        ) %>% 
    ggplot(aes(VALUE)) + 
    #geom_freqpoly(bins = 50, aes(color = DBP)) +
    geom_histogram(bins = 30, aes(fill = DBP), color = "black", alpha = 1)+
    facet_wrap(~DBP) +
    guides(fill = FALSE) +
    scale_x_continuous(lim = c(0,0.25))+
    labs(
        x = "CYLV errors [D]",
        y = ""
    )
    
```

### 4.3 GMC statistics with DBP OFF and ON

```{r INSGMC}
lens_pr_noerr_dbpvalid %>% 
    select(INSGMC, INSGMCDBP) %>% 
    gather(NAME, VALUE) %>% 
    mutate(
        DBP = str_detect(NAME, "DBP"),
        DBP = fct_recode(as.factor(DBP), DPB_OFF = "FALSE", DBP_ON = "TRUE"),
        NAME = str_replace(NAME, "DBP", "")
        ) %>% 
    ggplot(aes(VALUE)) + 
    #geom_freqpoly(bins = 50, aes(color = DBP)) +
    geom_histogram(bins = 30, aes(fill = DBP), color = "black", alpha = 1)+
    guides(fill = FALSE) +
    facet_wrap(~ DBP) +
    scale_x_continuous(lim = c(0,0.5))+
    labs(
        x = "INSGMC",
        y = ""
    )
```

### 4.4 AV statistics with DBP OFF and ON

```{r}
lens_pr_noerr_dbpvalid %>% 
    select(INSAV, INSAVDBP) %>% 
    gather(NAME, VALUE) %>% 
    mutate(
        DBP = str_detect(NAME, "DBP"),
        DBP = fct_recode(as.factor(DBP), DPB_OFF = "FALSE", DBP_ON = "TRUE"),
        NAME = str_replace(NAME, "DBP", "")
        ) %>% 
    ggplot(aes(VALUE)) + 
    #geom_freqpoly(bins = 50, aes(color = DBP)) +
    geom_histogram(bins = 30, aes(fill = DBP), color = "black", alpha = 1)+
    facet_wrap(~DBP) +
    guides(fill = FALSE) +
    scale_x_continuous(lim = c(0,0.25))+
    labs(
        x = "INSAV [D]",
        y = ""
    )
```


## Appendix

### Unsucessfull DBP jobs

```{r lens_auto_dbp_nv}
lens_pr_noerr_dbpnotvalid <- lens_pr_noerr %>% 
    filter(DBPVALID == FALSE) %>% 
    mutate(
        ERRDRSEQ = INSDRSPH+0.5*INSDRCYL-(LDDRSPH+0.5*LDDRCYL),
        ERRDRCYLV = sqrt(
            (INSDRCYL*cos(deg2rad(2*INSDRAX))-LDDRCYL*cos(deg2rad(2*LDDRAX)))^2+
            (INSDRCYL*sin(deg2rad(2*INSDRAX))-LDDRCYL*sin(deg2rad(2*LDDRAX)))^2
        )
    )
```


Let's look at the `r lens_pr_noerr_dbpnotvalid %>% nrow()` lenses with unsucessful DBP and examine the 
INSGMC and INSAV values.


```{r}
lens_pr_noerr_dbpnotvalid %>% 
    mutate(TIMESTAMP = date(TIMESTAMP)) %>%
    select(TIMESTAMP, JOB, EYE, DBPVALID, INSGMC, INSAV, ERRDRSEQ, ERRDRCYLV, LMERRCODE, LNAME) %>%
    arrange(desc(abs(INSAV), INSGMC)) %>% 
    kable()
```

Let's remove the lenses with a INSAV value greater than 0.5 (in absolute value), a GMC greater than 1
or a ERRCYLV error greater than 0.5.


```{r, lens_pr_noerr_dbpnotvalid_analyse}
lens_pr_noerr_dbpnotvalid_analyse <- lens_pr_noerr_dbpnotvalid %>% 
        filter(
        DBPVALID == FALSE,
        is.na(INSAV) | abs(INSAV) <= 0.5,
        is.na(INSAV) | abs(INSGMC) <= 1,
        is.na(ERRDRCYLV) | abs(ERRDRCYLV) <= 0.5
        ) 
```
The number of remaining lenses is `r lens_pr_noerr_dbpnotvalid_analyse %>% nrow()`.

```{r}
lens_pr_noerr_dbpnotvalid_analyse %>% 
    mutate(TIMESTAMP = date(TIMESTAMP)) %>% 
    select(TIMESTAMP, JOB, EYE, DBPVALID, INSGMC, INSAV, ERRDRSEQ, ERRDRCYLV, LMERRCODE, LNAME) %>%
    arrange(desc(abs(INSAV), INSGMC)) %>% 
    kable()
```

Among those lenses, here are the percentage of LNAME's : 
```{r}
lens_pr_noerr_dbpnotvalid_analyse %>% 
    mutate(TIMESTAMP = date(TIMESTAMP)) %>% 
    select(TIMESTAMP, JOB, EYE, DBPVALID, INSGMC, INSAV, ERRDRSEQ, ERRDRCYLV, LMERRCODE, LNAME) %>%
    count(LNAME) %>% 
    kable()
```

```{r}
lens_pr_noerr_dbpvalid %>% 
    filter(DBPVALID == TRUE) %>% 
    mutate(
        ERRDRSEQ = INSDRSPH+0.5*INSDRCYL-(LDDRSPH+0.5*LDDRCYL),
        ERRDRCYLV = sqrt(
            (INSDRCYL*cos(deg2rad(2*INSDRAX))-LDDRCYL*cos(deg2rad(2*LDDRAX)))^2+
            (INSDRCYL*sin(deg2rad(2*INSDRAX))-LDDRCYL*sin(deg2rad(2*LDDRAX)))^2
        )
    ) %>% 
    filter(
        is.na(INSAV) | abs(INSAV) <= 0.5,
        is.na(INSAV) | abs(INSGMC) <= 0.6,
        is.na(ERRDRCYLV) | abs(ERRDRCYLV) <= 0.5
        ) %>% 
    select(JOB, EYE, TIMESTAMP, DBPX, LDVEN, LNAME, LTYPE, INSGMC, INSGMCDBP) %>% 
    write_csv("data/luat_dbp_data_20190304.csv")
```









